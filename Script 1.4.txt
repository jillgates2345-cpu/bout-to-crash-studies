<script>
/* =========================
   GLOBAL GAME MANAGEMENT
========================= */

let currentInterval = null;
let currentKeyHandler = null;

function clearGame(){
  if(currentInterval){
    clearInterval(currentInterval);
    currentInterval = null;
  }
  if(currentKeyHandler){
    document.removeEventListener("keydown", currentKeyHandler);
    currentKeyHandler = null;
  }
}

function toggleFullscreen(){
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}

/* =========================
   SECTION NAVIGATION
========================= */

function showSection(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* =========================
   SAFE CALCULATOR + SECRET
========================= */

function calculate(){
  let v = document.getElementById("calcInput").value.trim();

  if(v === "420"){
    startArcade();
    return;
  }

  try {
    if(!/^[0-9+\-*/(). ]+$/.test(v)) throw "Invalid";
    document.getElementById("calcInput").value =
      Function('"use strict"; return (' + v + ')')();
  } catch {
    alert("Invalid");
  }
}

function startArcade(){
  document.getElementById("mainHeader").style.display="none";
  document.getElementById("mainNav").style.display="none";
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById("gameSection").style.display="block";
  loadLeaderboard();
}

function exitGame(){
  clearGame();
  document.getElementById("gameSection").style.display="none";
  document.getElementById("mainHeader").style.display="block";
  document.getElementById("mainNav").style.display="flex";
  showSection("math");
  document.getElementById("gameArea").innerHTML="";
  document.getElementById("leaderboard").innerHTML="";
}

/* =========================
   GAME LOADER
========================= */

function openGame(type){
  clearGame();
  document.getElementById("gameArea").innerHTML="";
  document.getElementById("leaderboard").style.display="none";

  switch(type){
    case "snake": snakeGame(); break;
    case "g2048": game2048(); break;
  }
}

/* =========================
   LEADERBOARD
========================= */

let leaderboard={snake:[],g2048:[]};

function saveScore(game,score){
  let arr=JSON.parse(localStorage.getItem("arcadeLeaderboard"))||leaderboard;
  if(!arr[game]) arr[game]=[];
  arr[game].push(score);
  arr[game].sort((a,b)=>b-a);
  if(arr[game].length>10) arr[game]=arr[game].slice(0,10);
  leaderboard=arr;
  localStorage.setItem("arcadeLeaderboard",JSON.stringify(leaderboard));
}

function loadLeaderboard(){
  leaderboard=JSON.parse(localStorage.getItem("arcadeLeaderboard"))||leaderboard;
}

/* =========================
   üêç SNAKE
========================= */

function snakeGame(){

  document.getElementById("gameArea").innerHTML=`
    <button onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
    <canvas id="snakeCanvas"></canvas>
    <p id="snakeScore"></p>
  `;

  const canvas=document.getElementById("snakeCanvas");
  const ctx=canvas.getContext("2d");

  canvas.width=window.innerWidth*0.8;
  canvas.height=window.innerHeight*0.7;

  const grid=20;
  let snake=[{x:200,y:200}];
  let dx=grid, dy=0;
  let score=0;

  function randomFood(){
    return {
      x:Math.floor(Math.random()*(canvas.width/grid))*grid,
      y:Math.floor(Math.random()*(canvas.height/grid))*grid
    };
  }

  let food=randomFood();

  currentKeyHandler=function(e){
    if(e.key==="ArrowUp"&&dy===0){dx=0;dy=-grid;}
    if(e.key==="ArrowDown"&&dy===0){dx=0;dy=grid;}
    if(e.key==="ArrowLeft"&&dx===0){dx=-grid;dy=0;}
    if(e.key==="ArrowRight"&&dx===0){dx=grid;dy=0;}
  };

  document.addEventListener("keydown",currentKeyHandler);

  function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    let head={x:snake[0].x+dx,y:snake[0].y+dy};

    if(head.x<0||head.y<0||
       head.x>=canvas.width||head.y>=canvas.height||
       snake.some(p=>p.x===head.x&&p.y===head.y)){
        alert("Game Over!");
        saveScore("snake",score);
        clearGame();
        return;
    }

    snake.unshift(head);

    if(head.x===food.x&&head.y===food.y){
      score++;
      food=randomFood();
    }else{
      snake.pop();
    }

    ctx.fillStyle="lime";
    snake.forEach(p=>ctx.fillRect(p.x,p.y,grid,grid));

    ctx.fillStyle="red";
    ctx.fillRect(food.x,food.y,grid,grid);

    document.getElementById("snakeScore").innerText="Score: "+score;
  }

  currentInterval=setInterval(loop,100);
}

/* =========================
   üü¶ 2048
========================= */

function game2048(){

  document.getElementById("gameArea").innerHTML=`
    <button onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
    <div id="board"></div>
    <p id="score2048"></p>
  `;

  let board=Array.from({length:4},()=>Array(4).fill(0));
  let score=0;

  function addTile(){
    let empty=[];
    for(let r=0;r<4;r++)
      for(let c=0;c<4;c++)
        if(board[r][c]===0) empty.push([r,c]);

    if(empty.length){
      let [r,c]=empty[Math.floor(Math.random()*empty.length)];
      board[r][c]=Math.random()<0.9?2:4;
    }
  }

  function draw(){
    let html="<table>";
    board.forEach(row=>{
      html+="<tr>";
      row.forEach(cell=>{
        html+=`<td style="
          width:80px;height:80px;
          border:2px solid lime;
          text-align:center;
          font-size:24px;
          color:lime">${cell||""}</td>`;
      });
      html+="</tr>";
    });
    html+="</table>";
    document.getElementById("board").innerHTML=html;
    document.getElementById("score2048").innerText="Score: "+score;
  }

  function slide(row){
    row=row.filter(v=>v);
    for(let i=0;i<row.length-1;i++){
      if(row[i]===row[i+1]){
        row[i]*=2;
        score+=row[i];
        row[i+1]=0;
      }
    }
    row=row.filter(v=>v);
    while(row.length<4) row.push(0);
    return row;
  }

  function rotate(){
    board=board[0].map((_,i)=>board.map(r=>r[i]).reverse());
  }

  function moveLeft(){ board=board.map(r=>slide(r)); }
  function moveRight(){ board=board.map(r=>slide(r.reverse()).reverse()); }
  function moveUp(){ rotate(); moveLeft(); rotate(); rotate(); rotate(); }
  function moveDown(){ rotate(); moveRight(); rotate(); rotate(); rotate(); }

  currentKeyHandler=function(e){
    let prev=JSON.stringify(board);

    if(e.key==="ArrowLeft") moveLeft();
    if(e.key==="ArrowRight") moveRight();
    if(e.key==="ArrowUp") moveUp();
    if(e.key==="ArrowDown") moveDown();

    if(prev!==JSON.stringify(board)){
      addTile();
      draw();

      if(board.flat().includes(2048)){
        alert("You Win!");
        saveScore("g2048",score);
        clearGame();
      }
    }
  };

  document.addEventListener("keydown",currentKeyHandler);

  addTile();
  addTile();
  draw();
}
</script>
